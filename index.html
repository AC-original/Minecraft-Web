<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Solstice</title>
<link rel="icon" href="icon.ico">
<link rel="stylesheet" href="style.css">
</head>
<body>
<div id="game_frame"></div>
<div id="intro_screen">
  <video id="intro_video"></video>
  <button id="continue_btn">Continue</button>
  <pre id="log_display"></pre>
</div>
<button id="launch_btn">Launch Game</button>
<script type="module">
"use strict";
const launch=document.getElementById("launch_btn"),
      cont=document.getElementById("continue_btn"),
      logEl=document.getElementById("log_display"),
      game=document.getElementById("game_frame"),
      intro=document.getElementById("intro_screen"),
      vid=document.getElementById("intro_video");
let contPressed=false;
function log(s){logEl.textContent+=s+"\n";logEl.scrollTop=logEl.scrollHeight;}

async function setEaglerDefaults(){
  if(!localStorage.getItem("_eaglercraftX.p")){
    let profile=await fetch("profile.txt").then(r=>r.text()).catch(()=>null);
    if(profile)localStorage.setItem("_eaglercraftX.p",profile.trim());
  }
  let servers=await fetch("servers.txt").then(r=>r.text()).catch(()=>null);
  if(servers)localStorage.setItem("_eaglercraftX.s",servers.trim());
  let global=await fetch("global.txt").then(r=>r.text()).catch(()=>null);
  if(global)localStorage.setItem("_eaglercraftX.g",global.trim());
}

function initEagler(){
  window.eaglercraftXOpts={container:"game_frame",worldsDB:"worlds",relays:[
    {addr:"wss://relay.deev.is/",comment:"lax1dude relay #1",primary:true},
    {addr:"wss://relay.lax1dude.net/",comment:"lax1dude relay #2",primary:false},
    {addr:"wss://relay.shhnowisnottheti.me/",comment:"ayunami relay #1",primary:false}],
    assetsURI:"assets.epw"
  };
  let c=game;while(c.firstChild)c.removeChild(c);c.appendChild(document.createElement("div"));
  fetch(window.eaglercraftXOpts.assetsURI,{cache:"force-cache"})
  .then(r=>r.arrayBuffer())
  .then(buf=>{
    const dv=new DataView(buf);
    if(dv.getUint32(0,true)!==608649541||dv.getUint32(4,true)!==1297301847)return log("Invalid EPW");
    const js=new Uint8Array(buf,dv.getUint32(164,true),dv.getUint32(168,true)),
          wasm=new Uint8Array(buf,dv.getUint32(180,true),dv.getUint32(184,true)),
          jsURL=URL.createObjectURL(new Blob([js],{type:"text/javascript"})),
          wasmURL=URL.createObjectURL(new Blob([wasm],{type:"application/wasm"})),
          ctx={};
    for(const [k,v] of Object.entries(window.eaglercraftXOpts))if(k!=="container"&&k!=="assetsURI")ctx[k]=v;
    window.__eaglercraftXLoaderContextPre={rootElement:c,eaglercraftXOpts:ctx,theEPWFileBuffer:buf,loaderWASMURL:wasmURL};
    const s=document.createElement("script");s.src=jsURL;document.head.appendChild(s);
    const orig=console.log;console.log=(...a)=>{let msg=a.join(" ");log(msg);orig(...a);
      if(msg.includes("Initializing audio context")&&!contPressed)cont.style.display="block";
      if(msg.includes("EagRuntime Version: EagRuntimeX 1.0")){intro.style.display="none";game.style.display="block";}
    };
  }).catch(()=>log("Error: unable to load assets.epw"));
}

launch.onclick=async()=>{
  launch.style.display="none";
  intro.style.display="flex";
  vid.src="intro.mp4";vid.autoplay=true;vid.muted=false;vid.play();
  await setEaglerDefaults();
  initEagler();
};

cont.onclick=()=>{
  contPressed=true;
  const btn=document.querySelector("._eaglercraftX_mobile_launch_client");
  if(btn)btn.click();
  cont.style.display="none";
};
</script>
</body>
</html>

